version: '{build}'

init:
  - cmd: net start MSSQL$%SQL_Instance%

environment:
  JAVA_HOME: C:\projects\pro\jdk-11
  mssql_jdbc_test_connection_properties: jdbc:sqlserver://localhost:1433;instanceName=%SQL_Instance%;databaseName=master;username=sa;password=Password12!;
  matrix:
    - SQL_Instance: SQL2008R2SP2
    - SQL_Instance: SQL2017

install:
  - ps: (new-object net.webclient).DownloadFile('https://download.java.net/java/early_access/jdk11/25/GPL/openjdk-11-ea+25_windows-x64_bin.zip', 'C:\projects\pro\openjdk-11.zip')
  - ps: Expand-Archive -Path C:\projects\pro\openjdk-11.zip -DestinationPath C:\projects\pro
  - cmd: echo "%JAVA_HOME%"
  - ps: Write-Host 'Installing JCE with powershell'
  - ps: cd AppVeyorJCE
  - ps: choco pack
  - ps: choco install jce -fdv -s . -y -failonstderr
  - ps: cd..
  - ps: mkdir AE_Certificates
  - ps: cd AE_Certificates
  - ps: $cert = New-SelfSignedCertificate -dns "AlwaysEncryptedCert" -CertStoreLocation Cert:CurrentUser\My  
  - ps: $pwd = ConvertTo-SecureString -String "password" -Force -AsPlainText
  - ps: $path = 'cert:\CurrentUser\My\' + $cert.thumbprint
  - ps: $certificate = Export-PfxCertificate -cert $path -FilePath cert.pfx -Password $pwd 
  - ps: Get-ChildItem -path cert:\CurrentUser\My > certificate.txt

cache:
  - C:\Users\appveyor\.m2 -> pom.xml

build_script:
  - keytool -importkeystore -srckeystore cert.pfx -srcstoretype pkcs12 -destkeystore clientcert.jks -deststoretype JKS -srcstorepass password -deststorepass password  
  - keytool -list -v -keystore clientcert.jks -storepass "password" > JavaKeyStore.txt
  - cd..
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V -Pbuild43
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V -Pbuild42
  
test_script:
  - mvn test -B -Pbuild43
  - mvn test -B -Pbuild42
